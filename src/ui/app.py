#!/usr/bin/env python3
"""
Streamlit UI for the Startup Evaluator chain.

2025-06-02
* Strip every instruction line before the first bullet (robust regex).
* Escape underscores to prevent unintended italics in Streamlit Markdown.
"""

from __future__ import annotations
import types, sys, os, logging, re
from pathlib import Path
from typing import Any, Dict, List
import streamlit as st

# ── Watchdog monkey-patch for PyTorch ─────────────────────────────────────────
_dummy = types.ModuleType("torch.classes"); _dummy.__path__ = []  # type: ignore[attr-defined]
sys.modules["torch.classes"] = _dummy
os.environ["STREAMLIT_WATCHDOG_IGNORE_DIRS"] = "torch"
os.environ["STREAMLIT_WATCHDOG_IGNORE_MODULES"] = "torch"

st.set_page_config(page_title="Startup Evaluator", layout="centered")

PROJECT_ROOT = Path(__file__).resolve().parent.parent.parent
sys.path.insert(0, str(PROJECT_ROOT))
from src.rag.chains import build_chain  # noqa: E402

logging.basicConfig(level=logging.INFO,
                    format="%(asctime)s [%(levelname)s] %(name)s: %(message)s")
logger = logging.getLogger(__name__)

# ───────────────────────────── Helper ────────────────────────────────────────
def postprocess_recommendations(raw: str) -> str:
    """
    Return just the four clean recommendation bullets.

    Steps
    -----
    1. Remove every line that starts with System: or Human:
    2. Discard 'INSUFFICIENT_CONTEXT' if it appears.
    3. Drop everything *before* the first bullet that begins with 'Market:'.
       Handles bullets like '- Market:', '* Market:', '• Market:'.
    4. Trim anything after the first '#' on the Team bullet.
    5. Escape underscores so Streamlit doesn't create italics.
    """
    txt = raw.replace("\r\n", "\n")

    # 1 ▸ remove scaffolding lines
    txt = "\n".join(
        ln for ln in txt.splitlines()
        if not re.match(r"^\s*(System|Human)\s*:", ln, flags=re.I)
    )

    # 2 ▸ drop literal token
    txt = txt.replace("INSUFFICIENT_CONTEXT", "")

    # 3 ▸ keep from the first Market bullet onwards
    bullet_pat = re.compile(r"^[\s\-\*\u2022]*Market\s*:", re.I | re.M)
    m = bullet_pat.search(txt)
    if m:
        txt = txt[m.start():]

    # 4 ▸ strip hashtags after Team bullet
    txt = re.sub(r"(Team:\s*.+?)(?:\s*#.*)$",
                 r"\1", txt, flags=re.I | re.S)

    # 5 ▸ escape underscores
    txt = txt.replace("_", r"\_")

    return txt.strip()

# ─────────────────────── Cache eval chain ────────────────────────────────────
@st.cache_resource
def get_eval_chain() -> Any:
    return build_chain(kind="eval", store="chroma")

eval_chain = get_eval_chain()

# ───────────────────────────── UI ────────────────────────────────────────────
st.title("🚀 Startup Evaluator")

summary: str = st.text_area(
    "Enter your startup summary (idea)",
    height=120,
    placeholder=("e.g., A VR fitness platform with real-time coaching features "
                 "and personalised workout plans…"),
)

if st.button("Evaluate Startup"):
    if not summary.strip():
        st.error("❗ Please enter a non-empty startup summary.")
    else:
        try:
            output: Dict[str, Any] = eval_chain({"question": summary})

            # 1 ▸ Similar examples
            st.subheader("📄 Three Similar Startup Examples")
            for idx, doc in enumerate(output.get("docs", []), 1):
                words = doc.strip().split()
                snippet = " ".join(words[:200]) + (" …" if len(words) > 200 else "")
                with st.expander(f"Example {idx}", expanded=False):
                    st.write(snippet)
            if not output.get("docs"):
                st.info("No similar startup examples retrieved.")

            # 2 ▸ VC recommendations (cleaned)
            st.subheader("💡 VC Recommendations")
            logger.info("result: " + output.get("result", ""))
            recs = postprocess_recommendations(output.get("result", ""))
            if recs:
                st.markdown(recs)
            else:
                st.info("No recommendations generated by the model.")

        except Exception as exc:  # noqa: BLE001
            logger.exception("Evaluator chain failed: %s", exc)
            st.error(f"Evaluation failed: {exc}")
